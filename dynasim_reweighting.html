<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Reweighting of DYNASIM Sample</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="dynasim_reweighting_files/libs/clipboard/clipboard.min.js"></script>
<script src="dynasim_reweighting_files/libs/quarto-html/quarto.js"></script>
<script src="dynasim_reweighting_files/libs/quarto-html/popper.min.js"></script>
<script src="dynasim_reweighting_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dynasim_reweighting_files/libs/quarto-html/anchor.min.js"></script>
<link href="dynasim_reweighting_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dynasim_reweighting_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dynasim_reweighting_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dynasim_reweighting_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dynasim_reweighting_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#acs-microdata-estimates" id="toc-acs-microdata-estimates" class="nav-link" data-scroll-target="#acs-microdata-estimates">ACS Microdata Estimates</a>
  <ul class="collapse">
  <li><a href="#women" id="toc-women" class="nav-link" data-scroll-target="#women">Women</a>
  <ul class="collapse">
  <li><a href="#mean-income" id="toc-mean-income" class="nav-link" data-scroll-target="#mean-income">Mean Income</a></li>
  <li><a href="#percentiles-of-income" id="toc-percentiles-of-income" class="nav-link" data-scroll-target="#percentiles-of-income">Percentiles of Income</a></li>
  <li><a href="#homeownership-rates" id="toc-homeownership-rates" class="nav-link" data-scroll-target="#homeownership-rates">Homeownership Rates</a></li>
  </ul></li>
  <li><a href="#men" id="toc-men" class="nav-link" data-scroll-target="#men">Men</a>
  <ul class="collapse">
  <li><a href="#mean-income-1" id="toc-mean-income-1" class="nav-link" data-scroll-target="#mean-income-1">Mean Income</a></li>
  <li><a href="#percentiles-of-income-1" id="toc-percentiles-of-income-1" class="nav-link" data-scroll-target="#percentiles-of-income-1">Percentiles of Income</a></li>
  <li><a href="#homeownership-rates-1" id="toc-homeownership-rates-1" class="nav-link" data-scroll-target="#homeownership-rates-1">Homeownership Rates</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#acs-tables" id="toc-acs-tables" class="nav-link" data-scroll-target="#acs-tables">ACS Tables</a>
  <ul class="collapse">
  <li><a href="#age-sex-race-tables" id="toc-age-sex-race-tables" class="nav-link" data-scroll-target="#age-sex-race-tables">Age-Sex-Race Tables</a></li>
  </ul></li>
  <li><a href="#raking" id="toc-raking" class="nav-link" data-scroll-target="#raking">Raking</a></li>
  <li><a href="#bibliography" id="toc-bibliography" class="nav-link" data-scroll-target="#bibliography">Bibliography</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Reweighting of DYNASIM Sample</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The DYNASIM starting sample contains a nationally representative sample of the population. The sample is constructed with two goals: (1) its distribution of a set of discrete variables like age, sex, race, education must be similar to the distribution of these variables in the population, and (2) the conditional distribution of a continuous variable like earnings or wealth conditional on these discrete variables in the sample must be similar to the one at the population level. The latter is verified by comparing the conditional mean of the continuous variable estimated on the sample with those estimated from nationally representative surveys.</p>
<p>When the area of interest is smaller, such as state or metro area, the DYNASIM sample can be reweighted to resemble the population of interest with respect to a set of individual and household characteristics. Two important choices regarding the weighting process are the choice of reweighting method and the choice of individual and household characteristics—control variables—to be used in reweighting.</p>
<p>There are several reweighting methods but some of them require a sample of the population of interest with the control variables. Because we don’t have such a sample, we don’t consider the methods that require it. One of the simplest and most commonly used methods is <em>raking</em>, which iteratively adjusts the weight for each person until the sample distributions of control variables matches the distributions of the target area. <span class="citation" data-cites="mercer2018">(<a href="#ref-mercer2018" role="doc-biblioref">Mercer, Lau, and Kennedy 2018</a>)</span> evaluated several reweighting methods and found that raking performs as well as more sophisticated methods. Another method proposed by <span class="citation" data-cites="schirm2002">(<a href="#ref-schirm2002" role="doc-biblioref">Schirm and Zaslavsky 2002</a>)</span> uses a <em>Poisson regression</em> to predict weights. Control variables are covariates in the regression. Observations are reweighted so that weighted sums of control variables equal targets values.</p>
<p>Regardless of method, control variables need to be selected with care and with consideration to the application. Because both of the above methods work with discrete variables, particularly challenging are applications in which continuous variables are of interest. In our case, it is important that the sample distribution of wealth matches the target distribution. One way to achieve this with the above methods is to use a categorical variable such as quintile or decile of wealth.</p>
<p>Because we are interested not only in its marginal distributions, but also in conditional distributions, we need to interact the control variables.</p>
</section>
<section id="acs-microdata-estimates" class="level1">
<h1>ACS Microdata Estimates</h1>
<p>This section shows estimates of income and homeownership rates for Boston, New York City, and Oakland based on the 5-year American Community Survey (2019). Included in the sample are adults ages 25 to 70 who identify as Black, Hispanic, or white. All estimates are done at the individual level using individual weights. The smallest cell in the sample has 28 observations for Hispanic women ages 55 to 70 with some college who live in Oakland.</p>
<section id="women" class="level2">
<h2 class="anchored" data-anchor-id="women">Women</h2>
<section id="mean-income" class="level3">
<h3 class="anchored" data-anchor-id="mean-income">Mean Income</h3>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</section>
<section id="percentiles-of-income" class="level3">
<h3 class="anchored" data-anchor-id="percentiles-of-income">Percentiles of Income</h3>
<section id="ages-25-39" class="level4">
<h4 class="anchored" data-anchor-id="ages-25-39">Ages 25-39</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</section>
<section id="ages-40-54" class="level4">
<h4 class="anchored" data-anchor-id="ages-40-54">Ages 40-54</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</section>
<section id="ages-55-70" class="level4">
<h4 class="anchored" data-anchor-id="ages-55-70">Ages 55-70</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-4-3.png" class="img-fluid" width="672"></p>
</section>
</section>
<section id="homeownership-rates" class="level3">
<h3 class="anchored" data-anchor-id="homeownership-rates">Homeownership Rates</h3>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</section>
</section>
<section id="men" class="level2">
<h2 class="anchored" data-anchor-id="men">Men</h2>
<section id="mean-income-1" class="level3">
<h3 class="anchored" data-anchor-id="mean-income-1">Mean Income</h3>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</section>
<section id="percentiles-of-income-1" class="level3">
<h3 class="anchored" data-anchor-id="percentiles-of-income-1">Percentiles of Income</h3>
<section id="ages-25-39-1" class="level4">
<h4 class="anchored" data-anchor-id="ages-25-39-1">Ages 25-39</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</section>
<section id="ages-40-54-1" class="level4">
<h4 class="anchored" data-anchor-id="ages-40-54-1">Ages 40-54</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="672"></p>
</section>
<section id="ages-55-70-1" class="level4">
<h4 class="anchored" data-anchor-id="ages-55-70-1">Ages 55-70</h4>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-7-3.png" class="img-fluid" width="672"></p>
</section>
</section>
<section id="homeownership-rates-1" class="level3">
<h3 class="anchored" data-anchor-id="homeownership-rates-1">Homeownership Rates</h3>
<p><img src="dynasim_reweighting_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</section>
</section>
</section>
<section id="acs-tables" class="level1">
<h1>ACS Tables</h1>
<section id="age-sex-race-tables" class="level2">
<h2 class="anchored" data-anchor-id="age-sex-race-tables">Age-Sex-Race Tables</h2>
<div class="cell">
<div id="fig-city-population-by-race" class="cell quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-city-population-by-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Population of each city by race
</figcaption>
<div aria-describedby="fig-city-population-by-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="fig-city-population-by-race-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-fig" id="fig-city-population-by-race-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) All ages
</figcaption>
<div aria-describedby="fig-city-population-by-race-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-city-population-by-race-1.png" class="img-fluid figure-img" data-ref-parent="fig-city-population-by-race" width="672">
</div>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-city-population-by-race-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-fig" id="fig-city-population-by-race-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Children younger than five
</figcaption>
<div aria-describedby="fig-city-population-by-race-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-city-population-by-race-2.png" class="img-fluid figure-img" data-ref-parent="fig-city-population-by-race" width="672">
</div>
</figure>
</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-city-population-by-race-age" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-city-population-by-race-age-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Population of each city by race and age group
</figcaption>
<div aria-describedby="fig-city-population-by-race-age-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-city-population-by-race-age-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-inc-to-pov-by-age-old" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-inc-to-pov-by-age-old-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The ratio of household income to poverty level for children ages 1-5
</figcaption>
<div aria-describedby="fig-inc-to-pov-by-age-old-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-inc-to-pov-by-age-old-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="raking" class="level1">
<h1>Raking</h1>
<div class="cell">
<div class="cell-output-display">
<div id="fig-inc-to-pov-lt6" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-inc-to-pov-lt6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The ratio of household income to poverty level for children younger than 6
</figcaption>
<div aria-describedby="fig-inc-to-pov-lt6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-inc-to-pov-lt6-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-race-sex-lt5" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-race-sex-lt5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Shaers of sex and race for children younger than 5
</figcaption>
<div aria-describedby="fig-race-sex-lt5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="dynasim_reweighting_files/figure-html/fig-race-sex-lt5-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="bibliography" class="level1">
<h1>Bibliography</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-mercer2018" class="csl-entry" role="listitem">
Mercer, Andrew, Arnold Lau, and Courtney Kennedy. 2018. <span>“For Weighting Online Opt-In Samples, What Matters Most?”</span>
</div>
<div id="ref-schirm2002" class="csl-entry" role="listitem">
Schirm, Allen L, and Alan M Zaslavsky. 2002. <span>“Reweighting a National Database to Improve the Accuracy of State Estimates.”</span> Arlington, VA.
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>