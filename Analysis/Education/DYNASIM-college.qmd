---
title: "DYNASIM College"
format:
  html:
    embed-resources: true
execute: 
  echo: false
  warning: false
fig-cap-location: top
---

```{r}

library(Hmisc)
library(ipumsr)
library(tidyverse)
library(tidyquant)
library(plotly)
library(urbnthemes)
set_urbn_defaults(style = "print", 
                  base_size=11,
                  base_line_size = 1
                  )

source(paste0(here::here(), "/RreadFEH/R/read_feh.R"))
source(paste0(here::here(), "/Analysis/Education/dyn_educ_lib.R"))

#obs = 50000
obs = NA
weight = 2537
first_year= 2006
last_year = 2100

years  = first_year:last_year
birth_years = 1980:2040
ages   = 16:40
grades = 12:18
sexes = c("All", "Men", "Women")
races = c("All", "Black", "Hispanic", "White")

keep_cols = c(
  'PERNUM',
  'DOBY',
  'SEX',
  'ETHNCTY',
  'SCHOOLST',
  'YEARDIED', 
  paste0('GRADECAT', first_year:last_year),
  paste0('EARNINGS', first_year:last_year),
  paste0('WEDSTATE', first_year:last_year),
  paste0('SAVINGS1', first_year:last_year),
  paste0('LHINCFPL', first_year:last_year)
)

fehdfs = list()

outcomes = c('N'='n', 'Share'="share")

#' Converts the outcome as displayed by GUI to the variable name
out2var = function(outcome, cumulative=FALSE)
{
    stopifnot(outcome %in% names(outcomes))
    res = outcomes[outcome]
    if(cumulative) {
        res = paste0("cum", res)
    }
    return(res)
}

make_form_output = function(data, var, form, by)
{
    data = data |>
        mutate(y = !!sym(out2var(var, FALSE)))
    
    if( form == "Diff") {
        data = left_join(
                data |> filter(dataset==fehname0) |> rename(y0=y) |> select(-dataset),
                data |> filter(dataset!=fehname0),
                by=by
            ) |>
            mutate(y=y-y0)
    }
    return(data)
}

educ_cats = c(
    "Less Than High School",
    "High School", 
    "Some College", 
    "Bachelor's Degree", 
    "Graduate School"
)

race_cats = c(
    "Asian",
    "Black",
    "Hispanic",
    "White",
    "Other"
)

pidx = read_csv(paste0(here::here(), "/pindex.csv"))
widx = read_csv(paste0(here::here(), "/windex.csv")) |>
    mutate(windex=windex*1e3)
pwidx = left_join(pidx, widx, by='year')
pidx2024 = pwidx |> filter(year==2024) |> select(pindex) |> pull()

```


```{r}
#| label: read-feh0
#| cache: false
#| cache.lazy: false
#| echo: false
#| output: false

fehname0       = "Baseline"
fehdir0        = "C:/Users/dcosic/Dynasim/Dynasim-babybonds/Dynasim-core/run/output/base_v32/"
fehdf0         = read_feh(fehdir0, columns=keep_cols, obs_count=obs)
fehdfs[[length(fehdfs)+1]] = feh_wide_to_long(fehdf0) |> mutate(dataset=fehname0)
```

```{r}
#| label: read-feh1
#| cache: false
#| cache.lazy: false
#| echo: false
#| output: false

fehname1       = "Baby bonds"
fehdir1        = "C:/Users/dcosic/Dynasim/Dynasim-babybonds/Dynasim-core/run/output/babybonds_v7"
fehdf1         = read_feh(fehdir1, columns=keep_cols, obs_count=obs)
fehdfs[[length(fehdfs)+1]] = feh_wide_to_long(fehdf1) |> mutate(dataset=fehname1)
```

```{r}
#| cache: false

fehdf = bind_rows(fehdfs) |>
    mutate(
        age = year-doby,
        sex = if_else(sex==1, "Men", "Women"),
        race= case_when(
            1014<=ethncty & ethncty<=1020       ~ 'Hispanic', 
            2014<=ethncty & ethncty<=2020       ~ 'Hispanic', 
            3014<=ethncty & ethncty<=3020       ~ 'Hispanic', 
            4014<=ethncty & ethncty<=4020       ~ 'Hispanic',
            1000<=ethncty & ethncty<=1099       ~ 'White',
            2000<=ethncty & ethncty<=2099       ~ 'Black',
            3000<=ethncty & ethncty<=3099       ~ 'Other',
            4000<=ethncty & ethncty<=4099       ~ 'Asian'
        ),
        weight=weight,
        dobycatold = cut(
            doby, 
            seq(1980,2040,10), 
            labels=paste0(seq(1980,2030,10), '-', seq(1989,2039,10)), 
            include.lowest = TRUE, 
            right=FALSE),
        dobycat = cut(
            doby, 
            seq(1974,2044,10), 
            labels=paste0(seq(1974,2034,10), '-', seq(1983,2043,10)), 
            include.lowest = TRUE, 
            right=FALSE),
        agecat = cut(
            age, 
            seq(15,44,5), 
            right=TRUE, 
            labels=paste0(seq(16,36,5),"-",seq(20,40,5)))
    ) |>
    filter(age>=16, race %in% races) |>
    left_join(pidx, by="year") |>
    mutate(rsavings1 = savings1/pindex*pidx2024)

```

```{r}

hincat16 = fehdf |>
    filter(age==16, lhincfpl>0) |>
    select(pernum, dataset, lhincfpl16=lhincfpl)

```


```{r}
educByAgeYearSexRace = fehdf |>
    filter(age %in% ages, year %in% years, gradecat %in% grades) |>
    sum_by_aser_time(year, age)    

educByAgeBCohSexRace = fehdf |>
    filter(age %in% ages, doby %in% birth_years, gradecat %in% grades) |>
    sum_by_aser_time(doby, age)    

educByAgeBCohcatSexRace = fehdf |>
    filter(age %in% ages, doby %in% birth_years, gradecat %in% grades) |>
    sum_by_aser_time(dobycat, age)    

```


```{r}
#| eval: FALSE

plotdf = dplyr::filter(
        educByAgeBCohcatSexRace, 
        dobycat=="2030-2039",
        sex=="All",
        gradecat==16
    )

plotdf |>
    ggplot2::ggplot(aes(
        x=age, 
        y=cumshare, 
        linetype=dataset,
        color=race,
        )) +
    geom_line()


```

## Distribution of Baby Bonds

```{r}
#| label: fig-babybonds-distr-age18-bc2024-2033
#| fig-cap: "Distribution of baby bonds at age 18 for birth cohorts 2024-2033 in 2024 dollars."

fehdf |>
    filter(age==18, dobycat=="2024-2033", dataset=="Baby bonds") |>
    ggplot(aes(x=rsavings1, color=race)) +
    stat_ecdf() +
    xlab("Baby Bonds ($2024 Thousands)") +
    ylab("Percentiles") +
    scale_x_continuous(labels=function(x) x/1000) +
    scale_y_continuous(labels=function(x) x*100) +
    coord_flip()

```

## Effect of Baby Bonds on College Education


### Share with BA at Ages 36-40

```{r}

plot_ycumshare_xyear_crace_tsex <- function(sextab)
{
  knitr::knit_child(text = c(
    "#### `r sextab`",
    "",
    "```{r}",
    "#| echo: false",
    "plotdf |>",
    "  filter(sex==sextab) |>",
    "  ggplot2::ggplot(aes(x=year, y=cumshare,linetype=dataset,color=race)) + ",
    "  geom_line() + ylab('Share with BA (%)') + ",
    "  scale_y_continuous(labels=function(x) {100*x})",
    "```",
    ""
    ), 
    envir = environment(), quiet = TRUE
  )
}


```


Share of population ages 36-40 with at least a BA degree by race and gender.

::: {.panel-tabset}

```{r}
#| label: bseduc-byrace-year-tabsex
#| results: asis


plotdf = fehdf |>
    filter(year>=2030, age %in% ages, gradecat %in% grades) |>
    sum_by_aser_time(year, agecat) |>
    filter(agecat=="36-40", gradecat==16) |>
    mutate(dataset=factor(dataset))

res = purrr::map_chr(c("All", "Women", "Men"), plot_ycumshare_xyear_crace_tsex)
cat(res, sep='\n')
```

:::


Share of population ages 36-40 with at least a BA degree among people whose family income was below 100 percent of the Federal Poverty Line at 16 by race and gender.

::: {.panel-tabset}

```{r}
#| label: bseduc-byrace-year-tabsex-100fpl16
#| results: asis

plotdf = left_join(
        fehdf,
        hincat16,
        by=c("pernum", "dataset")
    ) |>
    filter(year>=2030, lhincfpl16<100, age %in% ages, gradecat %in% grades) |>
    sum_by_aser_time(year, agecat) |>
    filter(agecat=="36-40", gradecat==16) |>
    mutate(dataset=factor(dataset))

res = purrr::map_chr(c("All", "Women", "Men"), plot_ycumshare_xyear_crace_tsex)
cat(res, sep='\n')
```

:::


```{r}
#| eval: FALSE

plotdf = left_join(
        fehdf,
        hincat16,
        by=c("pernum", "dataset")
    ) |>
    filter(year>=2030, lhincfpl16<100, age %in% ages, gradecat %in% grades) |>
    sum_by_aser_time(year, agecat) |>
    filter(agecat=="36-40", gradecat==16) |>
    mutate(dataset=factor(dataset))

plotdf |>
    filter(gradecat==16, sex=="All") |>
    ggplot(aes(x=year,y=cumshare, color=race, linetype=dataset)) +
    geom_line()

```


